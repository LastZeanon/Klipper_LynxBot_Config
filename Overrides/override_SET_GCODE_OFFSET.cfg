[gcode_macro SET_GCODE_OFFSET]
rename_existing: SET_GCODE_OFFSET_BASE
gcode:
  {% if params.INTELLIGENT is defined and params.INTELLIGENT|int == 1 and params.Z is defined %}
    {% set Z = params.Z|float %}

    {% if printer['gcode_macro _MESH_VARIABLES'].surfaces[printer.bed_mesh.profile_name] is defined %}
      {% set Z = Z + printer['gcode_macro _MESH_VARIABLES'].surfaces[printer.bed_mesh.profile_name] %}
    {% endif %}

    {% if params.X is defined %}
      {% set X = 'X=' ~ params.X %}
    {% else %}
      {% set X = '' %}
    {% endif %}

    {% if params.Y is defined %}
      {% set Y = 'Y=' ~ params.Y %}
    {% else %}
      {% set Y = '' %}
    {% endif %}

    {% set Z = 'Z=' ~ Z %}

    SET_GCODE_OFFSET_BASE {X} {Y} {Z}
  {% else %}
    SET_GCODE_OFFSET_BASE {% for p in params
                %}{'%s=%s ' % (p, params[p])}{%
               endfor %}
  {% endif %}
